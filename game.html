<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Random Element Picker</title>
    <style>
        body {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            background-color: #f2f2f2;
        }
        #container {
            display: flex;
            flex-direction: column;
            /*background-color: red;*/
        }
        .tab-container {
            justify-content: center; /* æ°´å¹³å±…ä¸­ */
            align-items: center; /* å‚ç›´å±…ä¸­ */
            display: flex;

        }
        .content-container {
            display: none;
            padding: 20px;
        }
        .content-container.active {
            display: block;
        }

        .button {
            background-color: blue;
            color: white;
            border: none;
            border-radius: 20px;
            padding: 10px 20px;
            font-size: 20px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .flagButton {
            background-color: #CCCCCC;
            color: white;
            border: none;
            border-radius: 20px;
            padding: 10px 30px;
            font-size: 20px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            margin: 10px 10px;
            display: none;
        }

        .chooseFault {
            background-color: tomato;
            front-color: white;
        }

        .chooseCorrect {
            background-color: green;
            front-color: white;
        }

        #answeredListClearButton {
            padding: 3px 10px;
            margin: 10px 10px -5px 10px;
            font-size: 14px;
        }

        .pagebtn {
            background-color: #6A5ACD;
            padding: 3px 10px;
            font-size: 12px;
            margin: 0px 5px;
        }

        #display {
            margin-top: 20px;
            font-size: 32px;
            text-align: center;
        }


        .item {
            flex: 1;
            display: flex;
            justify-content: center; /* æ°´å¹³å±…ä¸­ */
            align-items: center; /* å‚ç›´å±…ä¸­ */
            margin: 5px; /* æ·»åŠ é—´è·ï¼Œå¯é€‰ */
        }
        /* å¯¹ select å…ƒç´ è¿›è¡Œæ ·å¼é‡ç½® */
        select {
            /* å»é™¤é»˜è®¤çš„æ ·å¼ */
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            /* æ·»åŠ è‡ªå®šä¹‰æ ·å¼ */
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            background-color: #f9f9f9;
            font-size: 16px;
            color: #333;
            outline: none; /* å»é™¤é€‰ä¸­æ—¶çš„å¤–è¾¹æ¡† */
            cursor: pointer;
        }

        /* é¼ æ ‡æ‚¬åœæ—¶æ”¹å˜èƒŒæ™¯é¢œè‰² */
        select:hover {
            background-color: #e5e5e5;
        }

        /* é€‰ä¸­æ—¶æ”¹å˜èƒŒæ™¯é¢œè‰² */
        select:focus {
            background-color: #ddd;
        }

        /* ä¸‹æ‹‰ç®­å¤´æ ·å¼ */
        select::-ms-expand {
            display: none;
        }

        /* ä¸‹æ‹‰ç®­å¤´æ ·å¼ */
        select::after {
            content: "\25BC";
            position: absolute;
            top: 50%;
            right: 10px;
            transform: translateY(-50%);
            pointer-events: none; /* ç¦æ­¢ç®­å¤´è¢«ç‚¹å‡» */
        }

        /* é€‰é¡¹æ ·å¼ */
        select option {
            padding: 10px;
            background-color: #fff;
            color: #333;
        }

        /* é€‰é¡¹æ‚¬åœæ—¶æ ·å¼ */
        select option:hover {
            background-color: #e5e5e5;
        }

        .links-container {
            display: flex;
            justify-content: center; /* å±…ä¸­å¯¹é½ */
        }

        .links-container a {
            margin: 0 10px; /* è®¾ç½®è¶…é“¾æ¥ä¹‹é—´çš„é—´éš” */
            text-decoration: none;
            color: #333;
            font-weight: bold;
            transition: color 0.3s ease; /* æ·»åŠ é¢œè‰²è¿‡æ¸¡æ•ˆæœ */
        }

        .links-container a:hover {
            color: #ff6347; /* é¼ æ ‡æ‚¬åœæ—¶çš„é¢œè‰² */
        }



        .tab {
            display: inline-block;
            padding: 10px 20px;
            cursor: pointer;
            background-color: #f0f0f0;
            color: #333;
            font-weight: bold;
            border: none;
            border-radius: 20px;
            transition: background-color 0.3s;
        }

        .tab.active {
            background-color: #007bff;
            color: #fff;
        }

        .span-list {
            padding: 0;
            margin: 0;
            text-align: center;
        }

        .span-list div{
            margin-bottom: 10px; /* æ§åˆ¶å…ƒç´ ä¹‹é—´çš„å‚ç›´é—´è· */
            display: block; /* å°† span å…ƒç´ ä»¥å—çº§å…ƒç´ å±•ç¤ºï¼Œå®ç°å‚ç›´æ’åˆ— */
            padding: 5px 10px;
            background-color: #f0f0f0;
            border-radius: 5px;
            font-size: 20px;
            color: #333;
        }

        #pageNum {
            margin: 0px 5px;
        }

        .input-text {
            padding: 10px; /* å¢åŠ å†…è¾¹è· */
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 14px;
            outline: none;
            transition: border-color 0.3s;
            resize: vertical; /* å…è®¸å‚ç›´æ–¹å‘çš„æ‹–æ‹½è°ƒæ•´å¤§å° */
            min-height: 80px; /* è®¾ç½®æœ€å°é«˜åº¦ */
            min-width: 300px;
        }

        .input-text:focus {
            border-color: #007bff;
        }

        #answeredList{
            display: block;
        }
        .answeredWord:nth-child(5n) {
            clear: both;
        }
        .answeredWord {
            margin-left: 15px;
            margin-right: 5px;
            font-size: 14px;
            display: block;
            float: left;
            clear: none; /* æ¸…é™¤æµ®åŠ¨ */
        }
        .correctWord {
            color: green;
        }
        .faultWord {
            color: tomato;
            font-weight: bold;
        }


        /* å¼¹çª—å¤–éƒ¨æ ·å¼ */
        .popup {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 9999;
        }

        /* å¼¹çª—å†…å®¹æ ·å¼ */
        .popup-content {
            display: flex; /* ä½¿ç”¨ Flexbox å¸ƒå±€ */
            flex-direction: row; /* æ°´å¹³æ’åˆ— */
            align-items: center; /* å‚ç›´å±…ä¸­ */
            justify-content: space-between; /* å·¦å³å¯¹é½ */
            background-color: #f9f9f9;
            border: 1px solid #ddd;
            border-radius: 8px;
            width: 300px;
            padding: 20px;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        /* è¾“å…¥æ¡†æ ·å¼ */
        #baiduTok {
            width: calc(100% - 100px); /* è¾“å…¥æ¡†å æ®å‰©ä½™ç©ºé—´ */
            padding: 8px;
            margin-right: 5px; /* è¾“å…¥æ¡†å³è¾¹è· */
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 16px;
        }

        /* æŒ‰é’®æ ·å¼ */
        #popup button {
            width: 80px;
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        /* æŒ‰é’®æ‚¬åœæ ·å¼ */
        button:hover {
            background-color: #0056b3;
        }
    </style>
</head>
<body>
    
    <div id="container">
        <!-- é€‰é¡¹å¡ -->
        <div class="tab-container">
            <div class="tab active" onclick="tabSwitchEvent(0)">é—®ç­”æ¨¡å¼</div>
            <div class="tab" onclick="tabSwitchEvent(1)">å­¦ä¹ æ¨¡å¼</div>
            <div class="tab" onclick="tabSwitchEvent(2)">è‡ªå®šä¹‰</div>
        </div>
        <div class="item links-container" id="linkList"></div>
        <div class="item">
            <select id="options"></select>
        </div>
        <div class="content-container active">
            <div class="item">
                <button id="pickButton" class="button">ç‚¹å‡»æˆ‘</button>
            </div>

            <div id="display" class="item"></div>
            <div class="item">
                <button id="faultButton" class="flagButton chooseFault" onclick="appendAnsweredWord(0)">Ã—</button>
                <button id="correctButton" class="flagButton chooseCorrect"  onclick="appendAnsweredWord(1)">âœ“</button>
                <button id="answeredListClearButton" class="flagButton">æ¸…ç©º</button>
            </div>
            <div class="item" id="answeredList"></div>
        </div>
        <div class="content-container">
            <div class="item">
                <button id="prevButton" class="button prebtn pagebtn">ä¸Šä¸€é¡µ</button>
                <span id="pageNum">1</span>
                <button id="nextButton" class="button nextbtn pagebtn">ä¸‹ä¸€é¡µ</button>
            </div>

            <div id="displayAll" class="span-list"></div>

            <div id="popup" class="popup">
                <div class="popup-content">
                    <input type="text" id="baiduTok" placeholder="è¾“å…¥æ¡†">
                    <button onclick="hidePopup()">å®Œæˆ</button>
                </div>
            </div>
        </div>
        <div class="content-container">
            <div class="item">
                <textarea id="manualContent" class="input-text" placeholder="è¯·è¾“å…¥å†…å®¹"></textarea>
            </div>
        </div>
    <div>

    <script>
        document.addEventListener("DOMContentLoaded", function() {
            //åˆå§‹åŒ–é¡µé¢é€‰é¡¹
            initPageInfo();

            // ç”¨äºå­˜å‚¨å·²ç»å±•ç¤ºè¿‡çš„ç»“æœ
            const shownResults = [];

            // æ·»åŠ äº‹ä»¶ç»‘å®š
            document.getElementById("pickButton").addEventListener("click", function() {buttonClickEvent(shownResults);});
            document.getElementById("prevButton").addEventListener("click", function () {prevPageEvent();});
            document.getElementById("nextButton").addEventListener("click", function () {nextPageEvent();});
            document.getElementById("options").addEventListener("change", function(event) {optionChangeEvent(event)});
            document.getElementById("answeredListClearButton").addEventListener("click", function () {clearAnsweredWordList();});
        });
    </script>
    <script>
        // å…¨å±€å˜é‡ï¼Œ ç¼“å­˜è¯­éŸ³é“¾æ¥
        function clearAnsweredWordList() {
            document.getElementById("answeredList").innerHTML = "";
        }
        function appendAnsweredWord(result) {
            var displayWord = document.getElementById("display").textContent;

            if(displayWord === null || displayWord === "") {
                return;
            }

            var spanEle = document.createElement("span");
            spanEle.classList.add("answeredWord");
            if(result === 0) {
                spanEle.classList.add("faultWord");
                spanEle.textContent = displayWord + " Ã—";
            } else {
                spanEle.classList.add("correctWord");
                spanEle.textContent = displayWord + " âœ“";
            }

            var answeredList = document.getElementById("answeredList");
            var lastWordEle = answeredList.lastElementChild;

            if(lastWordEle !== null && lastWordEle.textContent.includes(displayWord)) {
                lastWordEle.remove();
            }

            answeredList.appendChild(spanEle);
        }
        // é€‰é¡¹åˆ‡æ¢äº‹ä»¶
        function optionChangeEvent(event) {
            //åªåœ¨å­¦ä¹ æ¨¡å¼å“åº”
            var currentMode = document.querySelectorAll(".tab.active")[0].textContent;
            if(currentMode !== "å­¦ä¹ æ¨¡å¼") {
                return;
            }

            document.getElementById("pageNum").textContent = 1;
            var select = document.getElementById("options");
            const selectedItem = select.options[select.selectedIndex].text;

            if(selectedItem !== "è‡ªå®šä¹‰") {
                var targetValue = select.value;
                var cachedData = localStorage.getItem(targetValue);
                if(!cachedData) {
                    console.log("fetch remote file content" + targetValue);

                    ( async() => {
                        const fileContent = await fetchRemoteFile(targetValue, selectedItem);
                        showPageModeContent(fileContent, 1);

                    })();
                } else {
                    showPageModeContent(cachedData, 1);
                }
            } else {
                var manualContent = document.getElementById("manualContent").value;
                showPageModeContent(manualContent, 1);
            }
        }

        // ä¸Šä¸€é¡µã€ä¸‹ä¸€é¡µåˆ‡æ¢äº‹ä»¶
        function prevPageEvent() {
            var pageNum = document.getElementById("pageNum");
            var currentPageNum = parseInt(pageNum.textContent);

            var select = document.getElementById("options");
            const selectedItem = select.options[select.selectedIndex].text;
            var cachedData = localStorage.getItem(selectedItem);

            pageNum.textContent =  currentPageNum <= 1 ? 1 : currentPageNum - 1;
            showPageModeContent(cachedData, pageNum.textContent);
        }

        function nextPageEvent() {
            var pageNum = document.getElementById("pageNum");
            var select = document.getElementById("options");
            const selectedItem = select.options[select.selectedIndex].text;
            var cachedData = localStorage.getItem(selectedItem);

            var maxPageNum = 0;
            var currentPageNum = parseInt(pageNum.textContent);
            if(!cachedData) {
                alert("æ²¡æœ‰æ›´å¤šå†…å®¹äº†");
            } else {
                var fileSize = cachedData.split("\n").length;
                maxPageNum = fileSize % 5 == 0 ? fileSize / 5 : fileSize / 5 + 1;
            }

            if(currentPageNum >= maxPageNum) {
                alert("æ²¡æœ‰æ›´å¤šå†…å®¹äº†");
            } else {
                pageNum.textContent =  currentPageNum + 1;
                showPageModeContent(cachedData, pageNum.textContent);
            }
        }

        // tabåˆ‡æ¢äº‹ä»¶
        function tabSwitchEvent(index) {
            tabSwitch(index);

            var select = document.getElementById("options");
            const selectedItem = select.options[select.selectedIndex].text;

            if(selectedItem !== "è‡ªå®šä¹‰") {
                var cachedData = localStorage.getItem(selectedItem);
                if(!cachedData) {
                    console.log("fetch remote file content");

                    ( async() => {
                        const fileContent = await fetchRemoteFile(select.value, selectedItem);
                        showPageModeContent(fileContent, 1);

                    })();
                } else {
                    showPageModeContent(cachedData, 1);
                }
            } else {
                var manualContent = document.getElementById("manualContent").value;
                showPageModeContent(manualContent, 1);
            }

        }
        // æŒ‰é’®ç‚¹å‡»äº‹ä»¶ï¼Œéšæœºå±•ç¤ºæ–‡æ¡ˆ
        function buttonClickEvent(shownResults) {
            var select = document.getElementById("options");

            const selectedItem = select.options[select.selectedIndex].text;
            if(selectedItem !== "è‡ªå®šä¹‰") {
                var cachedData = localStorage.getItem(selectedItem);
                if(!cachedData) {
                    console.log("fetch remote file content");

                    ( async() => {
                        const fileContent = await fetchRemoteFile(select.value, selectedItem);
                        showRandomContent(fileContent, shownResults);

                    })();
                } else {
                    showRandomContent(cachedData, shownResults);
                }
            } else {
                var manualContent = document.getElementById("manualContent").value;
                showRandomContent(manualContent, shownResults);
            }

            //å±•ç¤ºé”™è¯¯ã€æ­£ç¡®æŒ‰é’®
            document.getElementById("correctButton").style.display = "block";
            document.getElementById("faultButton").style.display = "block";
            document.getElementById("answeredListClearButton").style.display = "block";
        }

        function labaClickEvent(event) {
            //å·²ç»å­˜åœ¨å…ƒç´ 
            var audioEle = event.target.parentNode.querySelector("audio");
            if(audioEle !== null ){
                audioEle.play();
                return;
            }

            var popup = document.getElementById("popup");
            var baiduTok = document.getElementById("baiduTok").value;
            if(baiduTok === null || baiduTok === "") {
                popup.style.display = "block";
                return;
            }

            var speechContent = event.target.parentNode.textContent.split("(")[0];
            btts({
                tex: speechContent,
                tok: baiduTok,
                spd: 2,
                pit: 3,
                vol: 6,
                per: 0,
                aue:3,
                ctp:1
            }, {
                volume: 0.3,
                timeout: 10000,
                hidden: true,
                autoplay:true,
                onInit: function (htmlAudioElement) {

                },
                // æ–‡ä»¶ç”ŸæˆæˆåŠŸ
                onSuccess: function(htmlAudioElement) {
                    event.target.parentNode.appendChild(htmlAudioElement);
                },
                onError: function(text) {
                    alert(text);
                },
                onTimeout: function () {
                    alert('timeout');
                },
                // æ’­æ”¾å®Œæˆ
                onEnded: function(htmlAudioElement) {

                }
            });
        }

        function hidePopup() {
            document.getElementById("popup").style.display = "none";
        }

        // è·å–é€‰é¡¹åˆ—è¡¨
        function initPageInfo() {
            //æ¸…é™¤localstorege
            localStorage.clear();

            var remoteUrl = "https://raw.gitmirror.com/Pylol/word-storege/main/options";
            ( async() => {
                const optionListStr = await fetchRemoteFile(remoteUrl);
                const optionList = JSON.parse(optionListStr);

                var selectEle = document.getElementById("options");
                var linkList = document.getElementById("linkList");

                for ( const key in optionList) {
                    const option = document.createElement("option");
                    option.value = optionList[key];
                    option.textContent = key;
                    selectEle.appendChild(option);

                    const link = document.createElement("a")
                    link.href = optionList[key];
                    link.textContent = key;
                    link.target = "_blank";
                    linkList.appendChild(link);
                }

                // æ·»åŠ è‡ªå®šä¹‰é€‰é¡¹
                const option = document.createElement("option");
                option.value = "/";
                option.textContent = "è‡ªå®šä¹‰";
                selectEle.appendChild(option);
            })();

        }

        function tabSwitch(index) {
            var tabs = document.querySelectorAll('.tab');
            var contents = document.querySelectorAll('.content-container');
            // ç§»é™¤æ‰€æœ‰é€‰é¡¹å¡çš„ active ç±»
            tabs.forEach(function(tab) {
                tab.classList.remove('active');
            });
            // å°†ç‚¹å‡»çš„é€‰é¡¹å¡æ·»åŠ  active ç±»
            tabs[index].classList.add('active');

            // éšè—æ‰€æœ‰å†…å®¹
            contents.forEach(function(content) {
                content.classList.remove('active');
            });
            // æ˜¾ç¤ºå¯¹åº”ç´¢å¼•çš„å†…å®¹
            contents[index].classList.add('active');
        }
        function showPageModeContent(fileContent, page) {
            var display = document.getElementById("displayAll");
            while(display.firstChild) {
                display.firstChild.remove();
            }
            var items = fileContent.split('\n');

            var startIndex = page == null ? 0 : (page-1)*5;
            var endIndex = startIndex + 5 >= items.length ? items.length : startIndex + 5;
            for(var i=startIndex; i<endIndex; i++) {
                var div = document.createElement("div");
                div.textContent = items[i];
                div.style.color = getRandomColor();

                var span = document.createElement("span");
                span.textContent = "ğŸ“¢";
                span.classList.add("laba");
                span.addEventListener("click", function (event) {
                    labaClickEvent(event);
                });
                div.appendChild(span);

                display.appendChild(div);
            }
        }

        // éšæœºå±•ç¤ºæ–‡æ¡ˆ
        function showRandomContent(fileContent, shownResults) {
            var display = document.getElementById("display");
            const items = fileContent.split('\n');

            // æ£€æŸ¥æ˜¯å¦æ‰€æœ‰ç»“æœéƒ½å·²ç»å±•ç¤ºè¿‡ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™é‡ç½® shownResults
            if (shownResults.length === items.length) {
                shownResults = [];
            }

            // ä»æœªå±•ç¤ºè¿‡çš„ç»“æœä¸­éšæœºé€‰æ‹©ä¸€ä¸ª
            var availableItems = items.filter(function(item) {
                return !shownResults.includes(item);
            });
            var randomIndex = Math.floor(Math.random() * availableItems.length);
            var selectedItem = availableItems[randomIndex];

            // å°†å±•ç¤ºçš„ç»“æœæ·»åŠ åˆ° shownResults ä¸­
            shownResults.push(selectedItem);

            // æ›´æ–°å±•ç¤ºå…ƒç´ çš„æ–‡æœ¬å†…å®¹å’Œå­—ä½“é¢œè‰²
            display.textContent = selectedItem;
            display.style.color = getRandomColor();
        }

        // è·å–è¿œç¨‹æ–‡ä»¶å†…å®¹å¹¶ç¼“å­˜åˆ°æœ¬åœ°
        async function fetchRemoteFile(url, type) {
            // å¦åˆ™ä»è¿œç¨‹è·å–æ–‡ä»¶å†…å®¹ï¼Œå¹¶ç¼“å­˜åˆ°æœ¬åœ°
            const response = await fetch(url);

            if(!response.ok) {
                alert('è·å–æ–‡ä»¶æ—¶å‡ºé”™:');
            }

            const data = await response.text();

            if(type) {
                localStorage.setItem(type, data);
            }

            return data;
        }

        // æ–‡æ¡ˆçš„å±•ç¤ºéšæœºé¢œè‰²
        function getRandomColor() {
            var colors = ["#FF5733", "#FFC300", "#ff5733", "#C70039", "#900C3F", "#581845", "#FE6F5E", "#FF914D"];
            var randomIndex = Math.floor(Math.random() * colors.length);
            return colors[randomIndex];
        }
    </script>

<!--   BAIDU tts js lib     -->
<script>
    /**
     * æµè§ˆå™¨è°ƒç”¨è¯­éŸ³åˆæˆæ¥å£
     * @param {Object} param ç™¾åº¦è¯­éŸ³åˆæˆæ¥å£å‚æ•°
     * è¯·å‚è€ƒ https://ai.baidu.com/docs#/TTS-API/41ac79a6
     * @param {Object} options è·¨åŸŸè°ƒç”¨apiå‚æ•°
     *           timeout {number} è¶…æ—¶æ—¶é—´ é»˜è®¤ä¸è®¾ç½®ä¸º60ç§’
     *           volume {number} audioæ§ä»¶éŸ³é‡ï¼ŒèŒƒå›´ 0-1
     *           hidden {boolean} æ˜¯å¦éšè—audioæ§ä»¶
     *           autoDestory {boolean} æ’­æ”¾éŸ³é¢‘å®Œæ¯•åæ˜¯å¦è‡ªåŠ¨åˆ é™¤æ§ä»¶
     *           onInit {Function} åˆ›å»ºå®Œaudioæ§ä»¶åè°ƒç”¨
     *           onSuccess {Function} è¿œç¨‹è¯­éŸ³åˆæˆå®Œæˆï¼Œå¹¶ä¸”è¿”å›éŸ³é¢‘æ–‡ä»¶åè°ƒç”¨
     *           onError {Function}  è¿œç¨‹è¯­éŸ³åˆæˆå®Œæˆï¼Œå¹¶ä¸”è¿”å›é”™è¯¯å­—ç¬¦ä¸²åè°ƒç”¨
     *           onTimeout {Function} è¶…æ—¶åè°ƒç”¨ï¼Œé»˜è®¤è¶…æ—¶æ—¶é—´ä¸º60ç§’
     */
    function btts(param, options) {
        var url = 'http://tsn.baidu.com/text2audio';
        var opt = options || {};
        var p = param || {};

        // å¦‚æœæµè§ˆå™¨æ”¯æŒï¼Œå¯ä»¥è®¾ç½®autoplayï¼Œä½†æ˜¯ä¸èƒ½å…¼å®¹æ‰€æœ‰æµè§ˆå™¨
        var audio = document.createElement('audio');
        if (opt.autoplay) {
            audio.setAttribute('autoplay', 'autoplay');
        }

        // éšè—æ§åˆ¶æ 
        if (!opt.hidden) {
            audio.setAttribute('controls', 'controls');
        } else {
            audio.style.display = 'none';
        }

        // è®¾ç½®éŸ³é‡
        if (typeof opt.volume !== 'undefined') {
            audio.volume = opt.volume;
        }

        // è°ƒç”¨onInitå›è°ƒ
        isFunction(opt.onInit) && opt.onInit(audio);

        // é»˜è®¤è¶…æ—¶æ—¶é—´60ç§’
        var DEFAULT_TIMEOUT = 60000;
        var timeout = opt.timeout || DEFAULT_TIMEOUT;

        // åˆ›å»ºXMLHttpRequestå¯¹è±¡
        var xhr = new XMLHttpRequest();
        xhr.open('POST', url);

        // åˆ›å»ºformå‚æ•°
        var data = {};
        for (var p in param) {
            data[p] = param[p]
        }

        // èµ‹å€¼é¢„å®šä¹‰å‚æ•°
        data.cuid = data.cuid || data.tok;
        data.ctp = 1;
        data.lan = data.lan || 'zh';
        data.aue = data.aue || 3;

        // åºåˆ—åŒ–å‚æ•°åˆ—è¡¨
        var fd = [];
        for(var k in data) {
            fd.push(k + '=' + encodeURIComponent(data[k]));
        }

        // ç”¨æ¥å¤„ç†blobæ•°æ®
        var frd = new FileReader();
        xhr.responseType = 'blob';
        xhr.send(fd.join('&'));

        // ç”¨timeoutå¯ä»¥æ›´å…¼å®¹çš„å¤„ç†å…¼å®¹è¶…æ—¶
        var timer = setTimeout(function(){
            xhr.abort();
            isFunction(opt.onTimeout) && opt.onTimeout();
        }, timeout);

        xhr.onreadystatechange = function() {
            if (xhr.readyState == 4) {
                clearTimeout(timer);
                if (xhr.status == 200) {
                    if (xhr.response.type === 'audio/mp3') {
                        audio.setAttribute('src', URL.createObjectURL(xhr.response));
                        audio.onended = function() {
                            // document.body.removeChild(audio);
                            opt.onEnded(audio);
                        }

                        isFunction(opt.onSuccess) && opt.onSuccess(audio);
                    }

                    // ç”¨æ¥å¤„ç†é”™è¯¯
                    if (xhr.response.type === 'application/json') {
                        frd.onload = function(){
                            var text = frd.result;
                            isFunction(opt.onError) && opt.onError(text);
                        };
                        frd.readAsText(xhr.response);
                    }
                }
            }
        }

        // åˆ¤æ–­æ˜¯å¦æ˜¯å‡½æ•°
        function isFunction(obj) {
            if (Object.prototype.toString.call(obj) === '[object Function]') {
                return true;
            }
            return false;
        }
    }
</script>
</body>
</html>
